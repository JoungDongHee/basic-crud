name: Notify Discord on [API ë³€ê²½] commits

on:
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check commits for [API ë³€ê²½]
        id: check_api
        run: |
          echo "Checking commits for [API ë³€ê²½]:"
          # ê¸°ë³¸ê°’
          echo "found=false" >> $GITHUB_ENV

          # ì´ë²¤íŠ¸ í˜ì´ë¡œë“œì˜ commits ë°°ì—´ì„ ìˆœíšŒ
          for i in $(seq 0 $(($(jq '.commits | length' "$GITHUB_EVENT_PATH") - 1))); do
            commit_message=$(jq -r ".commits[$i].message" "$GITHUB_EVENT_PATH")
            commit_id=$(jq -r ".commits[$i].id" "$GITHUB_EVENT_PATH")
            echo "Found commit: $commit_message"

            # ì»¤ë°‹ ë©”ì‹œì§€ê°€ "[API ë³€ê²½]" ìœ¼ë¡œ ì‹œì‘í•˜ë©´ ê°ì§€
            if [[ "$commit_message" =~ ^\[API\ ë³€ê²½\] ]]; then
              echo "[API ë³€ê²½] commit detected."
              echo "found=true" >> $GITHUB_ENV
              echo "commit_message=$commit_message" >> $GITHUB_ENV
              echo "commit_id=$commit_id" >> $GITHUB_ENV
              break
            fi
          done

      - name: Notify Discord
        # '[API ë³€ê²½]' ì»¤ë°‹ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
        if: env.found == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          payload=$(jq -n --arg actor "${{ github.actor }}" \
                          --arg message "${{ env.commit_message }}" \
                          --arg commit_url "https://github.com/${{ github.repository }}/commit/${{ env.commit_id }}" \
            '{
              "embeds": [
                {
                  "title": "ğŸ”§ [API ë³€ê²½] ì»¤ë°‹ ê°ì§€",
                  "description": "\($actor)ë‹˜ì´ API ìŠ¤í™ ë³€ê²½ì„ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.\nğŸ“ \($message)\nğŸ”— [ì»¤ë°‹ ë³´ëŸ¬ ê°€ê¸°](\($commit_url))",
                  "color": 15105570,
                  "timestamp": (now | todateiso8601)
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d
