name: API ë³€ê²½ Discord Notification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  notify-api-change:
    # ì»¤ë°‹ ë©”ì‹œì§€/PR ì œëª©ì´ [APIë³€ê²½] ìœ¼ë¡œ ì‹œì‘í•  ë•Œë§Œ ì‹¤í–‰
    if: ${{ (github.event_name == 'push' && startsWith(github.event.head_commit.message, '[APIë³€ê²½]')) || (github.event_name == 'pull_request' && startsWith(github.event.pull_request.title, '[APIë³€ê²½]')) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # PR ê¸°ì¤€ ì»¤ë°‹ ë¹„êµ ë“±ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ ì‚¬ìš©
          fetch-depth: 0

      - name: Collect change summary
        id: changes
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name || github.actor }}"
            COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            BRANCH_NAME="${{ github.ref_name }}"
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
          else
            COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_URL="${{ github.event.pull_request.html_url }}"
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            CHANGED_FILES=$(git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" || true)
          fi

          # íŒŒì¼ ëª©ë¡ í¬ë§·íŒ…(ë¶ˆë¦¿ + ì½”ë“œí°íŠ¸)
          FORMATTED_FILES=""
          while IFS= read -r f; do
            [ -n "$f" ] && FORMATTED_FILES="${FORMATTED_FILES}â€¢ \`$f\`\n"
          done <<< "$CHANGED_FILES"

          FILE_COUNT=$(printf "%s\n" "$CHANGED_FILES" | sed '/^\s*$/d' | wc -l | tr -d ' ')

          {
            echo "commit_sha=$COMMIT_SHA"
            echo "commit_msg<<EOF"
            echo "$COMMIT_MSG"
            echo "EOF"
            echo "commit_author=$COMMIT_AUTHOR"
            echo "commit_url=$COMMIT_URL"
            echo "branch_name=$BRANCH_NAME"
            echo "file_count=$FILE_COUNT"
            echo "changed_files<<EOF"
            echo "$FORMATTED_FILES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          [ -z "$DISCORD_WEBHOOK_URL" ] && { echo "Missing DISCORD_WEBHOOK_URL secret"; exit 1; }

          if [ "${{ github.event_name }}" = "push" ]; then
            TITLE="ğŸš€ [APIë³€ê²½] ê°ì§€ (Push)"
            COLOR=3066993
          else
            TITLE="ğŸ“ [APIë³€ê²½] ê°ì§€ (PR)"
            COLOR=15844367
          fi

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          jq -n \
            --arg title "$TITLE" \
            --arg repo "${{ github.repository }}" \
            --arg repoUrl "${{ github.server_url }}/${{ github.repository }}" \
            --arg branch "\`${{ steps.changes.outputs.branch_name }}\`" \
            --arg author "${{ steps.changes.outputs.commit_author }}" \
            --arg msg "${{ steps.changes.outputs.commit_msg }}" \
            --arg files "${{ steps.changes.outputs.changed_files }}" \
            --arg url "${{ steps.changes.outputs.commit_url }}" \
            --argjson color $COLOR \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)" \
            '{
              embeds: [{
                title: $title,
                description: "ì»¤ë°‹ ë©”ì‹œì§€(ë˜ëŠ” PR ì œëª©)ê°€ `[APIë³€ê²½]`ìœ¼ë¡œ ì‹œì‘í•˜ì—¬ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.",
                color: $color,
                fields: [
                  { name: "ğŸ“ Repository", value: "["+$repo+"]("+$repoUrl+")", inline: true },
                  { name: "ğŸŒ¿ Branch", value: $branch, inline: true },
                  { name: "ğŸ‘¤ Author", value: $author, inline: true },
                  { name: "ğŸ’¬ Message / Title", value: $msg, inline: false },
                  { name: "ğŸ“„ Changed Files ('+"${{ steps.changes.outputs.file_count }}"+")", value: ($files | if . == "" then "_(no files listed)_" else . end), inline: false },
                  { name: "ğŸ”— View", value: "["+"Click to open"+"]("+$url+")", inline: false }
                ],
                footer: { text: "GitHub Actions â€¢ ${{ github.workflow }}", icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" },
                timestamp: $ts
              }]
            }' > discord_payload.json

          curl -sS -H "Content-Type: application/json" -d @discord_payload.json "$DISCORD_WEBHOOK_URL"

      - name: Summary
        run: |
          echo "## ğŸ”” [APIë³€ê²½] ì•Œë¦¼ ì „ì†¡ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜**: ${{ steps.changes.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‘ì„±ì**: ${{ steps.changes.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
          echo "- **íŒŒì¼ ìˆ˜**: ${{ steps.changes.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë©”ì‹œì§€ / ì œëª©" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changes.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
