name: API Changes Discord Notification

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  notify-api-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ 2ê°œ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°

      - name: Check commit message for API changes
        id: check-commit
        run: |
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG=$(git log -1 --pretty=format:'%s')
            COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
            COMMIT_EMAIL=$(git log -1 --pretty=format:'%ae')
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            BRANCH_NAME="${{ github.ref_name }}"
          else
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_EMAIL=""
            COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
            COMMIT_URL="${{ github.event.pull_request.html_url }}"
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          fi
          
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_email=$COMMIT_EMAIL" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # '[API ë³€ê²½]'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
          if [[ "$COMMIT_MSG" == \[API\ ë³€ê²½\]* ]]; then
            echo "is_api_change=true" >> $GITHUB_OUTPUT
            echo "âœ… API ë³€ê²½ ì»¤ë°‹ ê°ì§€: $COMMIT_MSG"
          else
            echo "is_api_change=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  ì¼ë°˜ ì»¤ë°‹: $COMMIT_MSG"
          fi

      - name: Get changed files
        id: changed-files
        if: steps.check-commit.outputs.is_api_change == 'true'
        run: |
          # ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
          else
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD || true)
          fi
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ëœ íŒŒì¼ ìˆ˜ ê³„ì‚°
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          else
            FILE_COUNT=0
          fi
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Get detailed commit info
        id: detailed-info
        if: steps.check-commit.outputs.is_api_change == 'true'
        run: |
          # ì¶”ê°€ ì»¤ë°‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_DATE=$(git log -1 --pretty=format:'%ci')
            FULL_MESSAGE=$(git log -1 --pretty=format:'%B')
          else
            COMMIT_DATE="${{ github.event.pull_request.created_at }}"
            FULL_MESSAGE="${{ github.event.pull_request.body }}"
          fi
          
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "full_message<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        if: steps.check-commit.outputs.is_api_change == 'true'
        run: |
          # Discord ì›¹í›… URL (GitHub Secretsì— ì €ì¥ëœ ê°’ ì‚¬ìš©)
          DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ í¬ë§·íŒ… (ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ í‘œì‹œ)
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
          FORMATTED_FILES=""
          FILE_COUNT=0
          while IFS= read -r file; do
            if [ -n "$file" ] && [ $FILE_COUNT -lt 10 ]; then
              FORMATTED_FILES="$FORMATTED_FILESâ€¢ \`$file\`\n"
              FILE_COUNT=$((FILE_COUNT + 1))
            fi
          done <<< "$CHANGED_FILES"
          
          # 10ê°œ ì´ìƒì¸ ê²½ìš° '...' ì¶”ê°€
          TOTAL_FILES=${{ steps.changed-files.outputs.file_count }}
          if [ $TOTAL_FILES -gt 10 ]; then
            FORMATTED_FILES="$FORMATTED_FILESâ€¢ ... ê·¸ ì™¸ $(($TOTAL_FILES - 10))ê°œ íŒŒì¼\n"
          fi
          
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ì œëª© ì„¤ì •
          if [ "${{ github.event_name }}" = "push" ]; then
            TITLE="ğŸš€ API ë³€ê²½ ì‚¬í•­ ì•Œë¦¼ (Push)"
            COLOR=15158332  # ë¹¨ê°„ìƒ‰
          else
            TITLE="ğŸ“ API ë³€ê²½ ì‚¬í•­ ì•Œë¦¼ (PR)"
            COLOR=15844367  # ë…¸ë€ìƒ‰
          fi
          
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ '[API ë³€ê²½]' ì œê±°í•œ ìˆœìˆ˜ ë©”ì‹œì§€
          CLEAN_MESSAGE=$(echo "${{ steps.check-commit.outputs.commit_msg }}" | sed 's/^\[API ë³€ê²½\] *//')
          
          # ì „ì²´ ì»¤ë°‹ ë©”ì‹œì§€ (body í¬í•¨) ì²˜ë¦¬
          FULL_MSG="${{ steps.detailed-info.outputs.full_message }}"
          if [ ${#FULL_MSG} -gt 1000 ]; then
            FULL_MSG="${FULL_MSG:0:1000}..."
          fi
          
          # Discord ë©”ì‹œì§€ JSON ìƒì„±
          cat << EOF > discord_payload.json
          {
            "content": "@here ğŸ”” **API ë³€ê²½ ì•Œë¦¼**",
            "embeds": [
              {
                "title": "$TITLE",
                "description": "**$CLEAN_MESSAGE**",
                "color": $COLOR,
                "fields": [
                  {
                    "name": "ğŸ“ Repository",
                    "value": "[${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})",
                    "inline": true
                  },
                  {
                    "name": "ğŸŒ¿ Branch",
                    "value": "\`${{ steps.check-commit.outputs.branch_name }}\`",
                    "inline": true
                  },
                  {
                    "name": "ğŸ‘¤ Author",
                    "value": "${{ steps.check-commit.outputs.commit_author }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“ Commit SHA",
                    "value": "\`${{{ steps.check-commit.outputs.commit_sha }}:0:7}\`",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“… Date",
                    "value": "${{ steps.detailed-info.outputs.commit_date }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“Š Changed Files",
                    "value": "**${{ steps.changed-files.outputs.file_count }}**ê°œ íŒŒì¼",
                    "inline": true
                  }
          EOF
          
          # íŒŒì¼ ëª©ë¡ì´ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -n "$FORMATTED_FILES" ]; then
            cat << EOF >> discord_payload.json
                  ,
                  {
                    "name": "ğŸ“„ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡",
                    "value": "$FORMATTED_FILES",
                    "inline": false
                  }
          EOF
          fi
          
          # ì „ì²´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€ (ì²« ì¤„ê³¼ ë‹¤ë¥¸ ê²½ìš°)
          if [ -n "$FULL_MSG" ] && [ "$FULL_MSG" != "${{ steps.check-commit.outputs.commit_msg }}" ]; then
            ESCAPED_FULL_MSG=$(echo "$FULL_MSG" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            cat << EOF >> discord_payload.json
                  ,
                  {
                    "name": "ğŸ“‹ ìƒì„¸ ë‚´ìš©",
                    "value": "$(echo "$ESCAPED_FULL_MSG" | head -c 1000)",
                    "inline": false
                  }
          EOF
          fi
          
          # JSON ë§ˆë¬´ë¦¬
          cat << EOF >> discord_payload.json
                  ,
                  {
                    "name": "ğŸ”— View Changes",
                    "value": "[ğŸ” ë³€ê²½ì‚¬í•­ ë³´ê¸°](${{ steps.check-commit.outputs.commit_url }})",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "GitHub Actions â€¢ ${{ github.workflow }} â€¢ API ë³€ê²½ ê°ì§€",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
              }
            ]
          }
          EOF
          
          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          response=$(curl -s -w "%{http_code}" -H "Content-Type: application/json" \
                          -d @discord_payload.json \
                          "$DISCORD_WEBHOOK_URL")
          
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -eq 204 ]; then
            echo "âœ… Discord ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨. HTTP ì½”ë“œ: $http_code"
            exit 1
          fi

      - name: Summary
        if: steps.check-commit.outputs.is_api_change == 'true'
        run: |
          echo "## ğŸ”” API ë³€ê²½ ì•Œë¦¼ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ê°ì§€ëœ ì»¤ë°‹**: ${{ steps.check-commit.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë³€ê²½ëœ íŒŒì¼ ìˆ˜**: ${{ steps.changed-files.outputs.file_count }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜**: ${{ steps.check-commit.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹ ì‘ì„±ì**: ${{ steps.check-commit.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Discord ì•Œë¦¼**: âœ… ì „ì†¡ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” ì»¤ë°‹ ìƒì„¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA**: \`${{ steps.check-commit.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ë§í¬**: [${{ steps.check-commit.outputs.commit_sha }}](${{ steps.check-commit.outputs.commit_url }})" >> $GITHUB_STEP_SUMMARY

      - name: No API changes detected
        if: steps.check-commit.outputs.is_api_change == 'false'
        run: |
          echo "â„¹ï¸  '[API ë³€ê²½]'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì»¤ë°‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "í˜„ì¬ ì»¤ë°‹ ë©”ì‹œì§€: ${{ steps.check-commit.outputs.commit_msg }}"